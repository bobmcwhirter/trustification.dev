apiVersion: v1
kind: Template
metadata:
  name: spog-api
objects:
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: spog-api
      labels:
        app.kubernetes.io/name: spog-api
        app.kubernetes.io/component: api
        app.kubernetes.io/part-of: spog
    spec:
      replicas: ${{ REPLICAS }}
      selector:
        matchLabels:
          app.kubernetes.io/name: spog-api
          app.kubernetes.io/component: api
          app.kubernetes.io/part-of: spog
      template:
        metadata:
          labels:
            app.kubernetes.io/name: spog-api
            app.kubernetes.io/component: api
            app.kubernetes.io/part-of: spog
        spec:
          containers:
            - image: ${IMAGE}:${IMAGE_TAG}
              imagePullPolicy: ${IMAGE_PULL_POLICY}
              name: service
              command: ["/trust"]
              args:
                - "spog"
                - "api"
                - "-p"
                - "8080"
                - "--bombastic-url"
                - "http://bombastic-api"
                - "--vexination-url"
                - "http://vexination-api"
                - "--crda-url"
                - "${CRDA_URL}"
                - "--auth-configuration"
                - "/etc/config.auth.yaml"
              env:
                - name: RUST_LOG
                  value: info
                - name: INFRASTRUCTURE_ENABLED
                  value: "true"
                - name: INFRASTRUCTURE_BIND
                  value: "[::]:9010"
                - name: SPOG_UI_CONFIG
                  value: /etc/config/spog-ui.yaml
                - name: SWAGGER_UI_OIDC_ISSUER_URL
                  value: "${FRONTEND_ISSUER_URL}"
              ports:
                - containerPort: 8080
                  protocol: TCP
                - containerPort: 9010
                  protocol: TCP
                  name: infra
              resources: "${{ RESOURCES }}"
              livenessProbe:
                httpGet:
                  path: /health/live
                  port: 9010
                initialDelaySeconds: 2
              readinessProbe:
                httpGet:
                  path: /health/ready
                  port: 9010
                initialDelaySeconds: 2
              startupProbe:
                httpGet:
                  path: /health/startup
                  port: 9010
              volumeMounts:
                - mountPath: /etc/config
                  name: config
          volumes:
            - name: config
              configMap:
                name: spog-api
  - apiVersion: v1
    kind: Service
    metadata:
      labels:
        app.kubernetes.io/name: spog-api
        app.kubernetes.io/component: api
        app.kubernetes.io/part-of: spog
      name: spog-api
    spec:
      ports:
      - name: endpoint
        port: 80
        protocol: TCP
        targetPort: 8080
      selector:
        app.kubernetes.io/name: spog-api
        app.kubernetes.io/component: api
        app.kubernetes.io/part-of: spog
      type: ClusterIP
parameters:
- name: IMAGE
- name: IMAGE_TAG
- name: CRDA_URL
- name: IMAGE_PULL_POLICY
  value: Always
- name: FRONTEND_ISSUER_URL
- name: REPLICAS
  value: "1"
- name: RESOURCES
  value: '{"requests": {"memory": "256Mi"}, "limits":{"memory": "256Mi"}}'
